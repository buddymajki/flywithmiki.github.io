<!DOCTYPE html>
<html>
<head>
    <title>FLYwithMIKI Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            border-radius: 1.5rem;
            background-color: #2d3748;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        }
        .student-card {
            margin-bottom: 1.5rem;
        }
        .w3-card-2 {
            background-color: #4a5568;
            padding: 1rem;
            border-radius: 1rem;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #2d3748;
            border-radius: 8px;
            overflow: hidden;
            height: 16px;
            margin: 0.5rem 0 1rem 0;
        }
        .progress-bar {
            height: 100%;
            background-color: #48bb78; /* zöld */
            transition: width 0.4s ease;
        }
        .sort-buttons {
            margin-bottom: 1rem;
        }
        .sort-buttons button {
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>

    <div class="container">
	    <img src="https://flywithmiki.com/Images_v2/logo1.webp" class="" alt="logoc" style="max-width:500px; width: 100%; filter: drop-shadow(7px 7px 7px white); display: block;">
		
        <h1 class="w3-text-white">Admin Dashboard</h1>
        <p class="w3-opacity">Student Progress Overview</p>

        <div class="sort-buttons">
            <button id="sort-name-btn" class="w3-button w3-blue" onclick="setSort('abc')">Sort by Name (ABC)</button>
            <button id="sort-flights-btn" class="w3-button w3-green" onclick="setSort('flights')">Sort by Total Flights</button>
        </div>

        <div id="student-container" class="w3-row-padding w3-margin-top"></div>
    </div>

<script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwo2_GUywCuJhWrT4WlFJAEOZqL2klbgBRWCitO_RZ1Wz_-vAteDC4z9g3dbiBCWkLp/exec';
    let studentsData = []; // itt tároljuk a betöltött diákokat

    // NEW: State object to track the current sorting key and order
    let currentSort = {
        key: 'abc',   // 'abc' or 'flights'
        order: 'asc'  // 'asc' or 'desc'
    };

    async function fetchStudentData() {
        const container = document.getElementById('student-container');
        container.innerHTML = 'Loading student data...';

        try {
            const response = await fetch(WEB_APP_URL + '?admin=true'); // fontos: admin=true
            const data = await response.json();

            if (data.status === 'success' && data.students.length > 0) {
                studentsData = data.students.filter(s => s.name && s.name.trim() !== "");
                // MODIFIED: Initial render call now uses the state management function
                renderStudents();
            } else {
                container.innerHTML = 'No student data found.';
            }
        } catch (error) {
            console.error('Error fetching data:', error);
            container.innerHTML = 'Failed to load data. Please try again later.';
        }
    }
    
    // NEW: Function to set the sorting state and trigger a re-render
    function setSort(key) {
        if (currentSort.key === key) {
            // If the same sort key is clicked, toggle the order
            currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
        } else {
            // If a new sort key is clicked, set it and apply a default order
            currentSort.key = key;
            currentSort.order = (key === 'flights') ? 'desc' : 'asc'; // Flights default to descending
        }
        renderStudents();
    }

    // NEW: Function to update the button text with sort indicators
        function updateSortButtons() {
            const nameBtn = document.getElementById('sort-name-btn');
            const flightsBtn = document.getElementById('sort-flights-btn');

            // Reset button texts to their default state
            nameBtn.textContent = 'Sort by Name (ABC)';
            flightsBtn.textContent = 'Sort by Total Flights';

            // Add indicator to the currently active sort button
            if (currentSort.key === 'abc') {
                // A-Z is ascending, Z-A is descending
                const arrow = currentSort.order === 'asc' ? ' ▲' : ' ▼'; 
                nameBtn.textContent += arrow;
            } else if (currentSort.key === 'flights') {
                // Low to high is ascending, high to low is descending
                const arrow = currentSort.order === 'asc' ? ' ▲' : ' ▼';
                flightsBtn.textContent += arrow;
            }
        }

    // MODIFIED: The render function now uses the global 'currentSort' state object
    function renderStudents() {
        const container = document.getElementById('student-container');
        container.innerHTML = '';

        let sortedStudents = [...studentsData];
        const { key, order } = currentSort; // Use state for sorting

        if (key === 'abc') {
            sortedStudents.sort((a, b) => a.name.localeCompare(b.name, 'hu'));
            if (order === 'desc') {
                sortedStudents.reverse();
            }
        } else if (key === 'flights') {
            sortedStudents.sort((a, b) => {
                const flightsA = parseInt(a.totalstart) || 0;
                const flightsB = parseInt(b.totalstart) || 0;
                // The comparison logic now depends on the 'order'
                return order === 'asc' ? flightsA - flightsB : flightsB - flightsA;
            });
        }
        
        // After sorting, update the buttons to reflect the current state
        updateSortButtons();

        sortedStudents.forEach(student => {
            const name = student.name.trim();
            const progress = parseFloat(student.p_chk) || 0;
            const progressPercent = Math.round(progress * 100);

            const totalFlights = student.totalstart || '0';
            const takeoffs = student.takeoffs || '0';
            const landings = student.landings || '0';

            const studentCard = document.createElement('div');
            studentCard.className = 'w3-third student-card';

            studentCard.innerHTML = `
                <div class="w3-card-2 w3-container">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <h3 class="w3-text-white" style="margin: 0;">${name}</h3>
                        <span style="font-size: 2rem; font-weight: bold; color: #63b3ed;">${totalFlights}</span>
                    </div>

                    <p><strong>Checklist Progress:</strong> ${progressPercent}%</p>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${progressPercent}%;"></div>
                    </div>
					
					<p><strong>Total flights</strong> ${totalFlights}</p>
						<div class="progress-bar-container">
							<div class="progress-bar" style="width: ${Math.min((totalFlights / 50) * 100, 100)}%;"></div>
						</div>
                    <p><strong>Takeoffs:</strong> ${takeoffs}</p>
                    <p><strong>Landings:</strong> ${landings}</p>
                </div>
            `;
            container.appendChild(studentCard);
        });
    }

    window.onload = fetchStudentData;
</script>
</body>
</html>