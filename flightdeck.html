<!DOCTYPE html>
<html>
<head>
    <title>FLYwithMIKI FlightDeck</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background similar to the image */
            color: #e2e8f0;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            border-radius: 1.5rem;
            background-color: #2d3748;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);

        }

        /* DASHBOARD kártyákhoz*/
		.w3-card-2 {
			background-color: #2d3748;
			border-radius: 1.5rem;
			box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
			padding: 2rem;
			height: 100%;
			/* Flexbox a tartalom középre igazításához */
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			text-align: center;
		}
		.my-flex-container {
			display: flex;
			justify-content: center; /* This will horizontally center the cards */
			align-items: stretch; /* This is the default, and it makes all flex items the same height */
			flex-wrap: wrap; /* Allows the items to wrap to a new line if the container is too narrow */
		}

		/* Optional: Add a class to the inner card div to make it a flex container as well.
		This helps if you need to align content vertically inside the card. */
		.my-card {
			display: flex;
			flex-direction: column;
			justify-content: center; /* This centers content vertically inside the card */
			height: 100%; /* Important for making sure the inner card fills its container */
		}		
		/* DASHBOARD kártyákhoz*/
        
		
		
        .check-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            border-bottom: 1px solid #4a5568;
            cursor: pointer;
            gap: 10px;
        }
        .check-item:last-child { border-bottom: none; }
        .check-item:hover { background-color: rgba(0,0,0,0.05); }
        .check-item.completed { 
            background: #2b352b; 
            color: #90ee90; 
            font-weight: bold; 
            text-decoration: line-through; 
            opacity: 0.7; 
        }


   /* Kiszínezi a checklist topicok fejlécét */
       .checklistheader {
            background-color: #9f7aea;
            color: #E5E1E1; 
            font-weight: bold;
            text-align: center;
            font-size: 25px;
        }

        
        
        .switch {
            position: relative;
            display: inline-block;
            width: 42px;
            height: 22px;
            cursor: pointer;
            flex-shrink: 0;
        }
        .switch input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
            margin: 0;
            padding: 0;
        }
        .slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .2s;
            border-radius: 22px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .2s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #4CAF50; }
        input:checked + .slider:before { transform: translateX(20px); }
        .check-item span { user-select: none; }
        #message {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
        }
        .tab-button {
            cursor: pointer;
            font-weight: bold;
        }

        /* Vertical bar chart styles */
        /* A százalékok konténere */
        .percentage-container {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 10px;
        }

        /* Az oszlopok közötti hely elosztása */
        .bar-chart-container {
            display: flex;
            justify-content: space-between; /* A sávok közötti teret egyenletesen osztja el, a széleken nem hagy teret */
            align-items: flex-end;
            gap: 1rem;
            width: 100%;
            height: 300px;
            padding: 0 16px; /* Belső margó a bal és jobb oldalon */
        }
        /* A barok egyforma szélességéért */
        .bar-wrapper {
            flex-grow: 1; /* Hogy kitöltse a rendelkezésre álló helyet */
            flex-shrink: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            height: 100%;
            max-width: 100px; /* Max szélesség, hogy ne legyenek túl nagyok az oszlopok */
        }

        /* Legendák stílusa */
        .bar-chart-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
            margin-top: 20px;
            padding: 10px;
            border-top: 1px solid #ddd;
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: #a0aec0;
        }

        .legend-color-box {
            width: 12px;
            height: 12px;
            margin-right: 5px;
            border-radius: 3px;
        }
        .bar {
            width: 100%;
            height: 100%;
            min-height: 50px;
            border-radius: 0.5rem;
            background-color: #2f3142;
            position: relative;
            display: flex;
            align-items: flex-end;
            overflow: hidden;
        }
        .bar-fill {
            width: 100%;
            background-color: #805ad5;
            border-radius: 0.5rem 0.5rem 0 0;
            transition: height 0.5s ease-in-out;
        }
        .bar-label {
            margin-top: 0.5rem;
            text-align: center;
            font-size: 0.875rem;
            color: #a0aec0;
            white-space: nowrap;
        }
        .bar-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Középre igazítás */
            font-size: 1.5vw;
            font-weight: bold;
            color: white; /* Fehér szöveg */
            text-shadow: 
                -1px -1px 0 #000,  
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000; /* Fekete "kontúr" */
            z-index: 10; /* Hogy a szöveg a kitöltés felett legyen */
        }


        /* Gauge specific styles */
        .gauge-svg-container {
            width: 100%;
            height: auto;
            display: block;
            margin-bottom: 0rem;
        }
        .gauge-text {
            font-weight: 700;
            font-size: 3rem;
        }
        .gauge-label {
            font-weight: 500;
            font-size: 1.25rem;
            color: #a0aec0;
        }

        /* NEW: Styles for the improved flight history list */
        .flight-entry {
            display: flex;
            flex-direction: column;
            padding: 16px;
            border-bottom: 1px solid #4a5568;
        }

        .flight-entry p {
            margin: 0;
            padding: 4px 0;
        }

        .flight-entry .flight-route {
            font-weight: bold;
            font-size: 1.1em;
            color: #e2e8f0;
        }

        .flight-entry .flight-details {
            font-size: 0.9em;
            color: #a0aec0;
        }
        
        /* NEW: Styles for the modal popup and loading overlay */
        .modal-overlay, .loading-overlay, #save-flight-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay {
            display: none; /* Hidden by default */
        }
        .loading-overlay, #save-flight-loading-overlay {
            display: none; /* Hidden by default */
            color: #e2e8f0;
            font-size: 1.5rem;
            text-align: center;
        }
        .login-popup {
            background-color: #2d3748;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
        }

        /* NEW: Loader CSS for initial load */
        .loader {
            width: 50px;
            aspect-ratio: 1;
            border: 2px solid;
            box-sizing: border-box;
            border-radius: 50%;
            display: grid;
            animation: l11 1.5s infinite linear;
            transform-origin: 50% 80%;
            margin-bottom: 1rem;
        }
        .loader:before,
        .loader:after {
            content: "";
            grid-area: 1/1;
            border: inherit;
            border-radius: 50%;
            animation: inherit;
            animation-duration: 1s;
            transform-origin: inherit;
        }
        .loader:after {
            --s:-1;
        }
        @keyframes l11 {
            100% {transform:rotate(calc(var(--s,1)*1turn))}
        }



        /* NEW: Loader CSS for Save Flight */
        .loader-save-flight {
            width: 60px;
            height: 25px;
            border: 2px solid;
            box-sizing: border-box;
            border-radius: 50%;
            display: grid;
            animation: l2 2s infinite linear;
            margin-bottom: 1rem; /* Added margin for spacing */
        }
        .loader-save-flight:before,
        .loader-save-flight:after {
            content: "";
            grid-area: 1/1;
            border: inherit;
            border-radius: 50%;
            animation: inherit;
            animation-duration: 3s;
        }
        .loader-save-flight:after {
            --s:-1;
        }
        @keyframes l2 {
            100% {transform:rotate(calc(var(--s,1)*1turn))}
        }



		/* NEW: Loader css for Save Checklist frissítéshez */
		/* HTML: <div class="loader-save-checklist"></div> */
		.loader-save-checklist {
		  width: 25px;
		  height: 50px;
		  display: grid;
		  background:
			linear-gradient(currentColor 0 0) top/100% 2px,
			radial-gradient(farthest-side at  top, #0000 calc(100% - 2px),currentColor calc(100% - 1px) ,#0000) top,
			linear-gradient(currentColor 0 0) bottom/100% 2px,
			radial-gradient(farthest-side at  bottom, #0000 calc(100% - 2px),currentColor calc(100% - 1px) ,#0000) bottom;
		  background-size: 100% 1px,100% 50%; 
		  background-repeat: no-repeat;
		  animation: l18 4s infinite linear;
		}
		.loader-save-checklist::before,
		.loader-save-checklist::after {
		  content: "";
		  grid-area: 1/1;
		  background: inherit;
		  border: inherit;
		  animation: inherit;
		}
		.loader-save-checklist::after {
		  animation-duration: 2s;
		}
		@keyframes l18 {
		  100% {transform: rotate(1turn)}
		}

/* Loader csomagoló: Ez biztosítja a középre igazítást */
.loader-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 1rem 0;
}

/* LOADER-gauge */
.loader-progressgauge {
    width: 50px;
    aspect-ratio: 1;
    color: #e2e8f0; /* A betöltő színe világos szürke lesz */
    border: 2px solid;
    display: grid;
    box-sizing: border-box;
    animation: l1 4s infinite linear;
    /* Ez a sor kulcsfontosságú! Elrejti a loadert alapértelmezetten, így a JavaScript tudja majd kezelni. */
    display: none; 
}
.loader-progressgauge::before,
.loader-progressgauge::after {
    content: "";
    grid-area: 1/1;
    margin: auto;
    width: 70.7%;
    aspect-ratio: 1;
    border: 2px solid;
    box-sizing: content-box;
    animation: inherit;
}
.loader-progressgauge::after {
    width: 50%;
    aspect-ratio: 1;
    border: 2px solid;
    animation-duration: 2s;
}
@keyframes l1 {
    100% {
        transform: rotate(1turn)
    }
}
		
		

		/* Theory gombok ugyan akkorák */		
		.same-width-button {
		  width: 250px; /* You can adjust this value as needed */
		  display: block;
		  margin-left: auto;
		  margin-right: auto;
		}



		/* ELVILEG A DASHBOARD KÁRTYÁKAT JOBBAN RENDEZI
/* Custom CSS */

/* Ezzel a szabállyal a mérőóra és a kártyák a helyükre kerülnek kis képernyőn is */
@media (max-width: 1000px) {
    .my-flex-container > .w3-half {
        width: 100% !important;
    }
}

/* Flexbox a kiskártyáknak */
.small-cards-flex {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
}

.dashboard-item {
    flex: 1 1 calc(50% - 16px);
    box-sizing: border-box;
    /* Ezek a sorok adják a teret a kártyák körül */
    margin: 8px; /* A kártyák közötti külső tér */
    padding: 8px; /* A kártyákon belüli belső tér */
}

/* Ha páratlan számú elem van, középre rendezzük a Flexbox-szal */
@media (min-width: 601px) {
    .small-cards-flex:after {
        content: "";
        flex: auto;
    }
}



    </style>

<link rel="icon" type="image/x-icon" href="https://flywithmiki.com/Images_v2/favicon.ico">


</head>
<body>


    <div class="container">
    <img src="https://flywithmiki.com/Images_v2/logo1.webp" class="" alt="logoc" style="max-width:900px; width: 100%; margin:auto; filter: drop-shadow(7px 7px 7px white); display: block;">
        
        
        <h1 class="w3-center" id="main-title">Flight Deck</h1>
		
		

        <h3 class="w3-center" id="login-tab">LOGIN</h3>




        <div class="w3-bar w3-asphalt" style="max-width:1150px; margin:auto">            
            <button class="w3-bar-item w3-button tab-button" id="dashboard-tab" style="display: none;">Dashboard</button>
            <button class="w3-bar-item w3-button tab-button" id="checklist-tab" style="display: none;">Checklist</button>
            <button class="w3-bar-item w3-button tab-button" id="flight-data-tab" style="display: none;">Flight Book</button>
            <button class="w3-bar-item w3-button tab-button" id="addflight-tab" style="display: none;">Add Flight</button>
			<button class="w3-bar-item w3-button tab-button w3-right" id="theory-tab" style="display: none;">Theory</button>
        </div>

        

<!--DASHBOARD------------------------------------------------------------------------------------->
<div id="dashboard-section" class="tab-content" style="display:none;">
            <div class="dashboard-container">
               

			<div class="loader-wrapper">
				<div class="loader-progressgauge" id="loader-progressgauge"></div>
			</div>
				<!--DASHBOARD KÁRTYÁK------------------------------------------------------------------------------------->
<div class="w3-row-padding w3-margin-top my-flex-container">
    
	<div class="w3-half w3-container w3-margin-bottom">
		<div class="w3-card-2">
			<h3 class="w3-center w3-text-gray">School progress</h3>
			<div class="loader-wrapper">
				<div class="loader-progressgauge" id="loader-progressgauge"></div>
			</div>
			<div class="gauge-svg-container" id="gauge-container"></div>
			<p class="w3-center w3-large" id="gauge-debug-text" style="margin-top: 10px;"></p>
		</div>
	</div>
		
    <div class="w3-half w3-row-padding small-cards-flex">
        <div class="dashboard-item">
            <div class="w3-card-2 w3-center my-card">
                <h3 class="w3-text-gray">Total Flights</h3>
                <div class="w3-xxlarge" id="total-flights-dashboard"><span id="total-flights-count-display">0</span></div>
            </div>
        </div>
        <div class="dashboard-item">
            <div class="w3-card-2 w3-center my-card">
                <h3 class="w3-text-gray">Total Airtime</h3>
                <div class="w3-xlarge" id="total-airtime-dashboard"><span id="total-air-time-summary">0 minutes</span></div>
            </div>
        </div>		
        <div class="dashboard-item">
            <div class="w3-card-2 w3-center my-card">
                <h3 class="w3-text-gray">Takeoff Sites</h3>
                <div class="w3-xxlarge w3-text-gray" id="takeoff-sites-dashboard"> <span id="takeoffs-count-display">0</span></div>
            </div>
        </div>
        <div class="dashboard-item">
            <div class="w3-card-2 w3-center my-card">
                <h3 class="w3-text-gray">Landing Sites</h3>
                <div class="w3-xxlarge" id="landing-sites-dashboard"><span id="landings-count-display">0</span></div>
            </div>
        </div>

        <div class="dashboard-item">
            <div class="w3-card-2 w3-center my-card">
                <h3 class="w3-text-gray">Cumm. Altitude</h3>
                <div class="w3-xlarge w3-text-gray" id="altitude-cumulative-dashboard">0 m</div>
            </div>
        </div>
    </div>

</div>
				<!--DASHBOARD KÁRTYÁK------------------------------------------------------------------------------------->
				
				


				<!--GRAFIKON KÁRTYÁK------------------------------------------------------------------------------------->			   
				<div class="w3-row-padding w3-margin-bottom my-flex-container">

					<div class="w3-threequarter w3-container w3-margin-bottom">
						<div class="w3-card-2 ">
							<h3 class="w3-center ">Control Sheet Progress</h3>
							<div class="bar-chart-container" id="bar-chart-container"></div>
							<div id="bar-chart-legend" class="w3-padding" ></div>
						</div>
					</div>
				</div>
				<!--GRAFIKON KÁRTYÁK------------------------------------------------------------------------------------->

				


				
            </div>
</div>
        
        

<!--Flightbook------------------------------------------------------------------------------------->
<div class="w3-container w3-padding tab-content" style="display:none;" id="flight-data-section">




            <div class="w3-card w3-round-large w3-margin">
                <div class="w3-container">
                    <h3>Flight history:</h3>
                    <ul id="flight-history-list" class="w3-ul w3-border-top">
                    </ul>
                </div>
            </div>
        </div>



<!-- ADDFLIGHT------------------------------------------------------------------------------------>
<div class="w3-container w3-padding tab-content" style="display:none;" id="addflight-section">
            <div id="flight-form-section">
                <div class="w3-card w3-round-large w3-margin">
                    <div class="w3-container">
                        <h3>New Flight</h3>
                        <form id="addflight-form" method="post">
                            <p>
                                <label>Date:</label>
                                <input class="w3-input w3-border w3-round-large" type="date" name="flight-date" id="addflight-date-input" required>
                            </p>
                            <p>
                                <label>Takeoff:</label>
                                <select class="w3-select w3-border w3-round-large" name="takeoff-location" id="addflight-takeoff-location" required>
                                    <option value="" disabled selected>Select a takeoff location</option>
                                    <option value="Büelen (1089m)">Büelen (1089m)</option>
                                    <option value="Brändlen-South (1208m)">Brändlen-South (1208m)</option>
                                    <option value="Brändlen-North (1228m)">Brändlen-North (1228m)</option>
                                    <option value="Diegisbalm (1103m)">Diegisbalm (1103m)</option>
                                    <option value="Engelberg - Brunnihütte (1868m)">Engelberg - Brunnihütte (1868m)</option>
                                    <option value="Engelberg - Tümpfeli (1803m)">Engelberg - Tümpfeli (1803m)</option>
                                    <option value="Emmetten - Niderbauen (1572m)">Emmetten - Niderbauen (1572m)</option>
                                    <option value="Rigi - Staffelhöhe (1546m)">Rigi - Staffelhöhe (1546m)</option>
                                    <option value="Rigi - Seebodenalp (1027m)">Rigi - Seebodenalp (1027m)</option>
									<option value="Rigi - Scheidegg (1641m)">Rigi - Scheidegg (1641m)</option>
									<option value="Rigi - Kulm (1768m)">Rigi - Kulm (1768m)</option>
									<option value="Rigi - Kulm SW (1737m)">Rigi - Kulm SW (1737m)</option>
                                    <option value="Rotenflue - W (1544m)">Rotenflue - W (1544m)</option>
									<option value="Rotenflue - Upper (1543m)">Rotenflue - Upper (1543m)</option>
									<option value="Rotenflue -  Lower (1517m)">Rotenflue -  Lower (1517m)</option>
                                    <option value="Urmiberg (1111m)">Urmiberg (1111m)</option>
									<option value="Zugerberg (938m)">Zugerberg (938m)</option>
                                </select>
                            </p>
                            <p>
                                <label>Landing:</label>
                                <select class="w3-select w3-border w3-round-large" name="landing-location" id="addflight-landing-location" required>
                                    <option value="" disabled selected>Select a landing location</option>
                                    
                                    <option value="Brunnen (434m)">Brunnen (434m)</option>
                                    <option value="Büelen - Neufallenbach (545m)">Büelen - Neufallenbach (545m)</option>
									<option value="Diegisbalm (Nechimatt) (540m)">Diegisbalm (Nechimatt) (540m)</option>
                                    <option value="Emmetten (788m)">Emmetten (788m)</option>
                                    <option value="Engelberg (1008m)">Engelberg (1008m)</option>
									<option value="Goldau (479m)">Goldau (479m)</option>
                                    <option value="Küssnacht (461m)">Küssnacht (461m)</option>
									<option value="Rotenflue - Rickenbach (586m)">Rotenflue - Rickenbach (586m)</option>
                                    <option value="Wolfenschiessen (514m)">Wolfenschiessen (514m)</option>
									<option value="Zug - Bröchli (463m)">Zug - Bröchli (463m)</option>
                                </select>
                            </p>
                            <p>
                                <label>Altitude Difference:</label>
                                <span id="addflight-altitude-difference" class="w3-tag w3-round-large w3-light-grey">0m</span>
                            </p>
                            <p>
                                <label>Flight Time:</label>
                                <select class="w3-select w3-border w3-round-large" name="flight-time" required>
                                    <option value="" disabled selected>Select flight time</option>
                                    <option value="5">5 minutes</option>
                                    <option value="10">10 minutes</option>
                                    <option value="15">15 minutes</option>
                                    <option value="20">20 minutes</option>
                                    <option value="25">25 minutes</option>
                                    <option value="30+">30+ minutes</option>
                                </select>
                            </p>
                            <p>
                                <label>Comments:</label>
                                <textarea class="w3-input w3-border w3-round-large" name="comments" rows="3"></textarea>
                            </p>
                            <p>
                                <button id="addflight-save-button" style="background-color:#805ad5" type="submit" class="w3-button w3-round-large w3-margin-bottom">Save Flight</button>
                            </p>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
 
 
 
<!--THEORY-----------------------------------------------------------------------------------> 
<div class="w3-container w3-padding tab-content" style="display:none;" id="theory-section">
    <div class="w3-card w3-round-large w3-margin">
        <div class="w3-container">
            <h3 class="w3-center w3-text-white">Theory Files</h3>
            <p>
                <a href="https://flywithmiki.com/theory/aerodynamics.pdf" target="_blank" class="w3-button w3-round-large w3-margin-bottom  same-width-button" style="background-color:#805ad5">Aerodynamics</a>
            </p>
            <p>
                <a href="https://flywithmiki.com/theory/flightpraxis.pdf" target="_blank" class="w3-button w3-round-large w3-margin-bottom  same-width-button" style="background-color:#805ad5">Flying practice</a>
            </p>
            <p>
                <a href="https://flywithmiki.com/theory/law.pdf" target="_blank" class="w3-button w3-round-large w3-margin-bottom same-width-button" style="background-color:#805ad5">Legislation (Airspaces)</a>
            </p>
            <p>
                <a href="https://flywithmiki.com/theory/material.pdf" target="_blank" class="w3-button w3-round-large w3-margin-bottom same-width-button" style="background-color:#805ad5">Material Sciences</a>
            </p>
            <p>
                <a href="https://flywithmiki.com/theory/meteo.pdf" target="_blank" class="w3-button w3-round-large w3-margin-bottom same-width-button" style="background-color:#805ad5">Weather</a>
            </p>
        </div>
    </div>
</div>
<!--THEORY----------------------------------------------------------------------------------->        
        
<!--CHECKLIST----------------------------------------------------------------------------------->
<div id="checklist-container" class="tab-content" style="display: none;">
            <form id="form">
                <div style="padding: 16px; text-align: center;">
                    <button class="w3-button w3-round" style="background-color:#805ad5" type="submit" id="submit-button">Save Checklist</button>
                </div>
				
		
				
				<H2 class="w3-center" style="align:center; margin:auto">Basic Training</h2>
                <div class="w3-row-padding w3-margin-top">
				<!--GHBAS-->
                    <div class="w3-half">
                        <div class="w3-card w3-white w3-margin-bottom">
							<header class="w3-container checklistheader">
								<h4>Basic Ground Handling and Launch Techniques</h4>
							</header>
							<div class="check-item">
								<span>1. Laying out the glider</span>
								<label class="switch">
									<input type="checkbox" id="gh-bas-0" name="gh-bas-0" value="TRUE" />
									<span class="slider"></span>
								</label>
							</div>
							<div class="check-item">
								<span>2. Equipment Familiarisation</span>
								<label class="switch">
									<input type="checkbox" id="gh-bas-1" name="gh-bas-1" value="TRUE" />
									<span class="slider"></span>
								</label>
							</div>
							<div class="check-item">
								<span>3. Inflation and walking exercises</span>
								<label class="switch">
									<input type="checkbox" id="gh-bas-2" name="gh-bas-2" value="TRUE" />
									<span class="slider"></span>
								</label>
							</div>
							<div class="check-item">
								<span>4. 5-Point Check and Launch Preparations</span>
								<label class="switch">
									<input type="checkbox" id="gh-bas-3" name="gh-bas-3" value="TRUE" />
									<span class="slider"></span>
								</label>
							</div>
							<div class="check-item">
								<span>5. Start-STOP (Decision making line)</span>
								<label class="switch">
									<input type="checkbox" id="gh-bas-4" name="gh-bas-4" value="TRUE" />
									<span class="slider"></span>
								</label>
							</div>
							<div class="check-item">
								<span>6. 3-Phase Launch (forward)</span>
								<label class="switch">
									<input type="checkbox" id="gh-bas-5" name="gh-bas-5" value="TRUE" />
									<span class="slider"></span>
								</label>
							</div>
							<div class="check-item">
								<span>7. Flights with Direction Changes</span>
								<label class="switch">
									<input type="checkbox" id="gh-bas-6" name="gh-bas-6" value="TRUE" />
									<span class="slider"></span>
								</label>
							</div>
							<div class="check-item">
								<span>8. Landing Techniques</span>
								<label class="switch">
									<input type="checkbox" id="gh-bas-7" name="gh-bas-7" value="TRUE" />
									<span class="slider"></span>
								</label>
							</div>
							<div class="check-item">
								<span>9. 90 - 180° Turns (Landing Approach)</span>
								<label class="switch">
									<input type="checkbox" id="gh-bas-8" name="gh-bas-8" value="TRUE" />
									<span class="slider"></span>
								</label>
							</div>
							<div class="check-item">
								<span>10. Folding Methods</span>
								<label class="switch">
									<input type="checkbox" id="gh-bas-9" name="gh-bas-9" value="TRUE" />
									<span class="slider"></span>
								</label>
							</div>
                        </div>
                       
                    </div>
					<!--GHBAS-->
					
					
					
					
					<!--GHADV-->
                    <div class="w3-half">
                        <div class="w3-card w3-white w3-margin-bottom">
							<header class="w3-container checklistheader">
								<h4>Advanced Groundhandling</h4>
							</header>
							<div class="check-item">
								<span>1. Slalom walking</span>
								<label class="switch">
									<input type="checkbox" id="gh-adv-0" name="gh-adv-0" value="TRUE" />
									<span class="slider"></span>
								</label>
							</div>
							<div class="check-item">
								<span>2. Crosswind Launch (Simulation if necessary)</span>
								<label class="switch">
									<input type="checkbox" id="gh-adv-1" name="gh-adv-1" value="TRUE" />
									<span class="slider"></span>
								</label>
							</div>
							<div class="check-item">
								<span>3. Launch with Poorly Laid-Out Canopy</span>
								<label class="switch">
									<input type="checkbox" id="gh-adv-2" name="gh-adv-2" value="TRUE" />
									<span class="slider"></span>
								</label>
							</div>
							<div class="check-item">
								<span>4. 3-Phase Launch (backward)</span>
								<label class="switch">
									<input type="checkbox" id="gh-adv-3" name="gh-adv-3" value="TRUE" />
									<span class="slider"></span>
								</label>
							</div>
							<div class="check-item">
								<span>5. Untangling the lines</span>
								<label class="switch">
									<input type="checkbox" id="gh-adv-4" name="gh-adv-4" value="TRUE" />
									<span class="slider"></span>
								</label>
							</div>
							<div class="check-item">
								<span>6. Hill walking</span>
								<label class="switch">
									<input type="checkbox" id="gh-adv-5" name="gh-adv-5" value="TRUE" />
									<span class="slider"></span>
								</label>
							</div>
                        </div>
					</div>

						<!--GHadv-->
                 </div>   




				<H2 class="w3-center" style="align:center; margin:auto">Theory</h2>				 
				<div class="w3-row-padding w3-margin-top">
					<!--TH-flight-->
                    <div class="w3-half">
                        <div class="w3-card w3-white w3-margin-bottom">
								<header class="w3-container checklistheader">
									<h4>In-Flight Safety and Emergency Procedures</h4>
								</header>
								<div class="check-item">
									<span>1. Introduction to Rescue System</span>
									<label class="switch">
										<input type="checkbox" id="th-flight-0" name="th-flight-0" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>2. Emergency Landing Techniques</span>
									<label class="switch">
										<input type="checkbox" id="th-flight-1" name="th-flight-1" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>3. Downwind Landing</span>
									<label class="switch">
										<input type="checkbox" id="th-flight-2" name="th-flight-2" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>4. Parachutal Stall</span>
									<label class="switch">
										<input type="checkbox" id="th-flight-3" name="th-flight-3" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>5. Spiral dive</span>
									<label class="switch">
										<input type="checkbox" id="th-flight-4" name="th-flight-4" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
                        </div>
					</div>
					<!--TH-flight-->

					<!--TH-core---->
                    <div class="w3-half">
                        <div class="w3-card w3-white w3-margin-bottom">
								<header class="w3-container checklistheader">
									<h4>Core Theory</h4>
								</header>
								<div class="check-item">
									<span>1. Aerodynamics</span>
									<label class="switch">
										<input type="checkbox" id="th-core-0" name="th-core-0" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>2. Weather</span>
									<label class="switch">
										<input type="checkbox" id="th-core-1" name="th-core-1" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>3. Flying practice</span>
									<label class="switch">
										<input type="checkbox" id="th-core-2" name="th-core-2" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>4. Legislation (Air-law and airspaces)</span>
									<label class="switch">
										<input type="checkbox" id="th-core-3" name="th-core-3" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>5. Material Sciences</span>
									<label class="switch">
										<input type="checkbox" id="th-core-4" name="th-core-4" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
                        </div>
					</div>
					<!--TH-core------>
				</div>
				
				
				
				
				<H2 class="w3-center" style="align:center; margin:auto">Altitude Flights</h2>				
				<div class="w3-row-padding w3-margin-top">				
					<!--HF-bas--->
                    <div class="w3-half">
                        <div class="w3-card w3-white w3-margin-bottom">
								<header class="w3-container checklistheader">
									<h4>Basic Flight Maneuvers</h4>
								</header>
								<div class="check-item">
									<span>1. Steering (positive)</span>
									<label class="switch">
										<input type="checkbox" id="hf-bas-0" name="hf-bas-0" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>2. Steering (negative)</span>
									<label class="switch">
										<input type="checkbox" id="hf-bas-1" name="hf-bas-1" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>3. Steering (weight shift)</span>
									<label class="switch">
										<input type="checkbox" id="hf-bas-2" name="hf-bas-2" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>4. Landing (school approach)</span>
									<label class="switch">
										<input type="checkbox" id="hf-bas-3" name="hf-bas-3" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>5. Big Ears (without speedbar)</span>
									<label class="switch">
										<input type="checkbox" id="hf-bas-4" name="hf-bas-4" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>6. Use of Acceleration System</span>
									<label class="switch">
										<input type="checkbox" id="hf-bas-5" name="hf-bas-5" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>7. Big Ears (with speedbar)</span>
									<label class="switch">
										<input type="checkbox" id="hf-bas-6" name="hf-bas-6" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
                        </div>
					</div>
					<!--HF-bas---->		

					<!--HF-adv-0--->
                    <div class="w3-half">
                        <div class="w3-card w3-white w3-margin-bottom">
								<header class="w3-container checklistheader">
									<h4>Advanced Flight Maneuvers</h4>
								</header>
								<div class="check-item">
									<span>1. Steering (back riser)</span>
									<label class="switch">
										<input type="checkbox" id="hf-adv-0" name="hf-adv-0" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>2. Landing (back riser)</span>
									<label class="switch">
										<input type="checkbox" id="hf-adv-1" name="hf-adv-1" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>3. Rolling (Big Ears)</span>
									<label class="switch">
										<input type="checkbox" id="hf-adv-2" name="hf-adv-2" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>4. Rolling</span>
									<label class="switch">
										<input type="checkbox" id="hf-adv-3" name="hf-adv-3" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>5. Pitching (Swiss style)</span>
									<label class="switch">
										<input type="checkbox" id="hf-adv-4" name="hf-adv-4" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>6. Side collapse (lvl1)</span>
									<label class="switch">
										<input type="checkbox" id="hf-adv-5" name="hf-adv-5" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>7. Side collapse (lvl2)</span>
									<label class="switch">
										<input type="checkbox" id="hf-adv-6" name="hf-adv-6" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>8. Side collapse (lvl3)</span>
									<label class="switch">
										<input type="checkbox" id="hf-adv-7" name="hf-adv-7" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>9. Side collapse (lvl4)</span>
									<label class="switch">
										<input type="checkbox" id="hf-adv-8" name="hf-adv-8" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>10. Front collapse</span>
									<label class="switch">
										<input type="checkbox" id="hf-adv-9" name="hf-adv-9" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>11. Flying in the Safe Speed Range</span>
									<label class="switch">
										<input type="checkbox" id="hf-adv-10" name="hf-adv-10" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>12. Tight circles</span>
									<label class="switch">
										<input type="checkbox" id="hf-adv-11" name="hf-adv-11" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>13. Quick Direction Changes</span>
									<label class="switch">
										<input type="checkbox" id="hf-adv-12" name="hf-adv-12" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>14. Circle Left, Circle Right (Figure Eight)</span>
									<label class="switch">
										<input type="checkbox" id="hf-adv-13" name="hf-adv-13" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>15. Flying with instruments</span>
									<label class="switch">
										<input type="checkbox" id="hf-adv-14" name="hf-adv-14" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>16. Soaring / Thermalling (30+ minutes)</span>
									<label class="switch">
										<input type="checkbox" id="hf-adv-15" name="hf-adv-15" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>17. Landing (popo)</span>
									<label class="switch">
										<input type="checkbox" id="hf-adv-16" name="hf-adv-16" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
                        </div>
					</div>
					<!--HF-adv--->						
				</div>
				
				
				
				
				<H2 class="w3-center" style="align:center; margin:auto">Exam Preparation</h2>				
				<div class="w3-row-padding w3-margin-top">				
					
					<!--ex--->
                    <div class="w3-half">
                        <div class="w3-card w3-white w3-margin-bottom">
								<header class="w3-container checklistheader">
									<h4>Examination Tasks </span></h4>
								</header>
								<div class="check-item">
									<span>1. Forward start</span>
									<label class="switch">
										<input type="checkbox" id="ex-0" name="ex-0" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>2. Backward start</span>
									<label class="switch">
										<input type="checkbox" id="ex-1" name="ex-1" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>3. Two right circles (720°, less than 20s), PP1</span>
									<label class="switch">
										<input type="checkbox" id="ex-2" name="ex-2" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>4. Eight (360° left, 360° right, less than 25s),PP2</span>
									<label class="switch">
										<input type="checkbox" id="ex-3" name="ex-3" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>5. Side Collapse (level3)</span>
									<label class="switch">
										<input type="checkbox" id="ex-4" name="ex-4" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>6. Big Ears (90° left, 90° right)</span>
									<label class="switch">
										<input type="checkbox" id="ex-5" name="ex-5" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>7. Big Ears (with full speed)</span>
									<label class="switch">
										<input type="checkbox" id="ex-6" name="ex-6" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>8. Rolling</span>
									<label class="switch">
										<input type="checkbox" id="ex-7" name="ex-7" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
								<div class="check-item">
									<span>9. Pitching</span>
									<label class="switch">
										<input type="checkbox" id="ex-8" name="ex-8" value="TRUE" />
										<span class="slider"></span>
									</label>
								</div>
                        </div>
					</div>
					<!--ex--->						

                 
                </div>
				
				
				
                <div style="padding: 16px; text-align: center;">
                    <button class="w3-button w3-round" style="background-color:#805ad5" type="submit" id="submit-button">Save Checklist</button>
                </div>
            </form>
        </div>
        
    </div>
    
    <!-- NEW: Modal and Loading Overlays -->
<div id="modal-overlay" class="modal-overlay">
    <div class="login-popup">
        <div id="login-section" class="tab-content" style="display: flex; flex-direction: column; align-items: center;">
            <img src="https://flywithmiki.com/Images_v2/logo1.webp" class="w3-margin-bottom" alt="logoc" style="max-width:400px; margin:auto; width: 100%; filter: drop-shadow(7px 7px 7px white); display: block;">
            
            <input class="w3-input w3-border w3-round" style="margin:auto; margin-top: 30px;" type="email" id="email-input" placeholder="Your email address">
            <button class="w3-button w3-round w3-margin-top" id="load-button" style="margin:auto; background-color:#805ad5">Load My Progress</button>
        </div>
    </div>
</div>

    <div id="loading-overlay" class="loading-overlay">
        <div class="loader"></div>
        <span>Doing the five point check, please wait...</span>
    </div>

    <!-- NEW: Loading Overlay for Save Flight -->
    <div id="save-flight-loading-overlay" class="loading-overlay">
        <div class="loader-save-flight"></div>
        <span>Sending your flight to the cloudbase ;)</span>
    </div>

    <!-- NEW: Loading Overlay for Save Flight -->
    <div id="save-checklist-loading-overlay" class="loading-overlay">
        <div class="loader-save-checklist"></div>
        <span>Alientechnology is calculating your progress...</span>
    </div>

<script>
    // Változás 1: Globális változó a nem mentett állapot figyelésére
    let isDirty = false;

    // Változás 2: showTab függvény módosítása a nem mentett állapot ellenőrzéséhez
    function showTab(tabId) {
        // Ellenőrizzük, hogy vannak-e nem mentett változások, de ne figyelmeztessünk, ha a felhasználó a menthető fülek (checklist, add flight) között vált.
        const savableTabs = ['checklist-container', 'addflight-section'];
        const isSwitchingBetweenSavableTabs = savableTabs.includes(tabId) && savableTabs.includes(document.querySelector('.tab-content[style*="display: block"]').id);
        
        if (isDirty) {
            const userDecision = confirm("Hold on! You haven't packed your gear! Are you sure you want to take off without hitting the save button?");
            if (!userDecision) {
                return; // Megszakítja a navigációt
            }
        }
        // Ha a felhasználó továbbhalad, a nem mentett állapotot alaphelyzetbe állítjuk.
        isDirty = false;

        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.style.display = 'none';
        });

        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('w3-blue');
        });

        document.getElementById(tabId).style.display = 'block';
        
        const buttonId = tabId === 'login-section' ? 'login-tab' :
                         tabId === 'checklist-container' ? 'checklist-tab' :
                         tabId === 'dashboard-section' ? 'dashboard-tab' :
                         tabId === 'addflight-section' ? 'addflight-tab' :
						 tabId === 'theory-section' ? 'theory-tab' : 'flight-data-tab';
        document.getElementById(buttonId).classList.add('w3-blue');
    }

    // Változás 3: Figyelmeztetés a böngésző "vissza" vagy "bezárás" gombjára
    window.addEventListener('beforeunload', function (e) {
        if (isDirty) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // A meglévő elemek és funkciók
    const mainTitle = document.getElementById('main-title');
    const form = document.getElementById("form");
    const submitButton = document.getElementById("submit-button");
    const emailInput = document.getElementById("email-input");
    const loadButton = document.getElementById("load-button");
    const modalOverlay = document.getElementById('modal-overlay');
    const loadingOverlay = document.getElementById('loading-overlay');
    const saveFlightLoadingOverlay = document.getElementById('save-flight-loading-overlay');
    const saveChecklistLoadingOverlay = document.getElementById('save-checklist-loading-overlay');
    const addflightForm = document.getElementById("addflight-form");
    const addflightTakeoffSelect = document.getElementById("addflight-takeoff-location");
    const addflightLandingSelect = document.getElementById("addflight-landing-location");
    const addflightAltitudeDifferenceSpan = document.getElementById("addflight-altitude-difference");
    const addflightDateInput = document.getElementById("addflight-date-input");
    const addflightSaveButton = document.getElementById("addflight-save-button");
    const checklistTabButton = document.getElementById("checklist-tab");
    const dashboardTabButton = document.getElementById("dashboard-tab");
    const flightDataTabButton = document.getElementById("flight-data-tab");
    const addflightTabButton = document.getElementById("addflight-tab");
    const loginTabButton = document.getElementById("login-tab");
	const theoryTabButton = document.getElementById("theory-tab");
    const scriptURL = "https://script.google.com/macros/s/AKfycbwo2_GUywCuJhWrT4WlFJAEOZqL2klbgBRWCitO_RZ1Wz_-vAteDC4z9g3dbiBCWkLp/exec";
    const barChartContainer = document.getElementById('bar-chart-container');
    const gaugeContainer = document.getElementById('gauge-container');
    const totalAirTimeSummary = document.getElementById("total-air-time-summary");
    const flightHistoryList = document.getElementById("flight-history-list");
    const gaugeProperties = {
        radius: 150,
        strokeWidth: 25,
        backgroundArcColor: '#2f3142',
        foregroundArcColor: '#805ad5',
        textColor: '#595959',
    };

    function createVerticalBars(data) {
        const barChartContainer = document.getElementById('bar-chart-container');
        barChartContainer.innerHTML = '';
        data.forEach(item => {
            const barWrapper = document.createElement('div');
            barWrapper.classList.add('bar-wrapper');
            const bar = document.createElement('div');
            bar.classList.add('bar');
            bar.style.height = '100%';
            const barFill = document.createElement('div');
            barFill.classList.add('bar-fill');
            barFill.style.height = `${item.value}%`;
            barFill.style.backgroundColor = item.color;
            const percentageText = document.createElement('span');
            percentageText.classList.add('bar-percentage');
            percentageText.textContent = `${item.value.toFixed(0)}%`;
            bar.appendChild(barFill);
            bar.appendChild(percentageText);
            barWrapper.appendChild(bar);
            barChartContainer.appendChild(barWrapper);
        });
    }


//kiszedi a haladás lineáris értékét a database-ből
async function fetchGaugeData(email) {
    const backendUrl = "https://script.google.com/macros/s/AKfycbwo2_GUywCuJhWrT4WlFJAEOZqL2klbgBRWCitO_RZ1Wz_-vAteDC4z9g3dbiBCWkLp/exec";
    const sheetName = "progr-sheet";
    const url = `${backendUrl}?sheet=${sheetName}&email=${encodeURIComponent(email)}`;

    // Változó a loader elemhez, most már az új ID-vel
    const gaugeLoader = document.getElementById('loader-progressgauge');
    const debugTextElement = document.getElementById('gauge-debug-text');

    // Betöltés kezdete: megjelenítjük a loadert és töröljük a hibaüzenetet
    if (gaugeLoader) {
        gaugeLoader.style.display = "block";
    }
    if (debugTextElement) {
        debugTextElement.textContent = "";
    }

    try {
        const response = await fetch(url);
        const data = await response.json();

        if (data.status === "success" && data.progress && data.progress.linear) {
            const linearValue = parseFloat(data.progress.linear);
            if (!isNaN(linearValue)) {
                // Sikeres betöltés: elrejtjük a loadert és létrehozzuk a grafikont
                if (gaugeLoader) {
                    gaugeLoader.style.display = "none";
                }
                createGauge(linearValue);
            } else {
                console.error("The 'linear' value is not a valid number:", data.progress.linear);
                if (gaugeLoader) {
                    gaugeLoader.style.display = "none";
                }
                if (debugTextElement) {
                    debugTextElement.textContent = "Error: The value is not a number.";
                }
            }
        } else {
            console.error("Failed to fetch gauge data:", data.message);
            if (gaugeLoader) {
                gaugeLoader.style.display = "none";
            }
            if (debugTextElement) {
                debugTextElement.textContent = "Error: Failed to retrieve data.";
            }
        }
    } catch (error) {
        console.error("Error fetching gauge data:", error);
        if (gaugeLoader) {
            gaugeLoader.style.display = "none";
        }
        if (debugTextElement) {
            debugTextElement.textContent = "Error: Network issue.";
        }
    }
}

// You will call this function after the user logs in and the email is available.
// For example:
// const userEmail = 'user@example.com'; 
// fetchGaugeData(userEmail); 

// Existing createGauge function


function createGauge(percentage) {
    const gaugeContainer = document.getElementById('gauge-container'); // Assuming an element with this ID exists
    if (!gaugeContainer) {
        console.error("Gauge container element not found.");
        return;
    }
    gaugeContainer.innerHTML = '';

    const { radius, strokeWidth, backgroundArcColor, foregroundArcColor, textColor } = gaugeProperties;
    const center = radius + strokeWidth / 2;
    const circumference = Math.PI * radius;
    const svgWidth = 2 * center;
    const svgHeight = center + strokeWidth;
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('viewBox', `0 0 ${svgWidth} ${svgHeight}`);
    svg.setAttribute('class', 'w-full');
    const backgroundArc = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    backgroundArc.setAttribute('d', `M${center - radius},${center} A${radius},${radius} 0 0 1 ${center + radius},${center}`);
    backgroundArc.setAttribute('fill', 'none');
    backgroundArc.setAttribute('stroke', backgroundArcColor);
    backgroundArc.setAttribute('stroke-width', strokeWidth);
    backgroundArc.setAttribute('stroke-linecap', 'round');
    const foregroundArc = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    foregroundArc.setAttribute('d', `M${center - radius},${center} A${radius},${radius} 0 0 1 ${center + radius},${center}`);
    foregroundArc.setAttribute('fill', 'none');
    foregroundArc.setAttribute('stroke', foregroundArcColor);
    foregroundArc.setAttribute('stroke-width', strokeWidth);
    foregroundArc.setAttribute('stroke-linecap', 'round');
    foregroundArc.setAttribute('stroke-dasharray', `${circumference},${circumference}`);
    foregroundArc.setAttribute('stroke-dashoffset', circumference * (1 - (percentage / 100)));
    const percentText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    percentText.setAttribute('x', center);
    percentText.setAttribute('y', center - 50);
    percentText.setAttribute('text-anchor', 'middle');
    percentText.setAttribute('dominant-baseline', 'middle');
    percentText.setAttribute('class', 'gauge-text');
    percentText.setAttribute('fill', textColor);
    percentText.textContent = `${percentage}%`;
    svg.appendChild(backgroundArc);
    svg.appendChild(foregroundArc);
    svg.appendChild(percentText);
    gaugeContainer.appendChild(svg);
}

// Call the new function to fetch and display the gauge when needed, 
// for example, when the page loads or a user logs in.
// fetchGaugeData("example.user@email.com"); // Replace with the user's actual email




    
    function updateCompletion(cardElement) {
        const checkboxes = cardElement.querySelectorAll('input[type="checkbox"]');
        const checkedCheckboxes = Array.from(checkboxes).filter(checkbox => checkbox.checked);
        const totalCheckboxes = checkboxes.length;
        let completionPercentage = 0;
        if (totalCheckboxes > 0) {
            completionPercentage = (checkedCheckboxes.length / totalCheckboxes) * 100;
        }
        const completionDisplay = cardElement.querySelector('.completion-display');
        if (completionDisplay) {
            completionDisplay.textContent = `${completionPercentage.toFixed(0)}%`;
        }
        return completionPercentage;
    }

    function updateAllCompletions() {
        const allCards = document.querySelectorAll('.w3-card');
        const chartData = [];
        const legendContainer = document.getElementById('bar-chart-legend');
        legendContainer.innerHTML = '';
        allCards.forEach(card => {
            const cardTitle = card.querySelector('header h4');
            if (cardTitle) {
                const topic = cardTitle.textContent.replace(/\s+\d+%$/, '').trim();
                const completionPercentage = updateCompletion(card);
                const color = getRandomColor();
                chartData.push({
                    topic: topic,
                    value: completionPercentage,
                    color: color
                });
                const legendItem = document.createElement('div');
                legendItem.classList.add('legend-item');
                legendItem.innerHTML = `<span style="background-color: ${color};" class="legend-color-box"></span> ${topic}`;
                legendContainer.appendChild(legendItem);
            }
        });
        createVerticalBars(chartData);
    }

    function getRandomColor() {
        const colors = ['#805ad5', '#4fd1c5', '#d53f8c', '#f6ad55', '#4299e1', '#e53e3e'];
        return colors[Math.floor(Math.random() * colors.length)];
    }

    function setChecklistValues(progress, clientName) {
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            const value = progress[checkbox.name];
            const isChecked = (String(value).toLowerCase() === "true");
            checkbox.checked = isChecked;
            const parentDiv = checkbox.closest('.check-item');
            if (parentDiv) {
                parentDiv.classList.toggle('completed', isChecked);
            }
        });
        mainTitle.innerHTML = clientName ? `Student Flight Deck <br> Welcome ${clientName}` : 'Student Flight Deck <br> Welcome Anonymus';
        updateAllCompletions();
    }

    function calculateAltitudeDifference(takeoffSelectElement, landingSelectElement, altitudeDifferenceElement) {
        const takeoffValue = takeoffSelectElement.value;
        const landingValue = landingSelectElement.value;
        let takeoffAltitude = 0;
        let landingAltitude = 0;
        if (takeoffValue) {
            const match = takeoffValue.match(/\((\d+)m\)/);
            if (match) {
                takeoffAltitude = parseInt(match[1]);
            }
        }
        if (landingValue) {
            const match = landingValue.match(/\((\d+)m\)/);
            if (match) {
                landingAltitude = parseInt(match[1]);
            }
        }
        const difference = takeoffAltitude - landingAltitude;
        altitudeDifferenceElement.textContent = `${difference}m`;
    }

    function formatMinutesToHoursAndMinutes(totalMinutes) {
        if (totalMinutes < 0) {
            return "Invalid time";
        }
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        let timeString = "";
        if (hours > 0) {
            timeString += `${hours}h `;
        }
        timeString += `${minutes}min`;
        return timeString.trim();
    }

    function updateFlightSummary(flights) {
        flightHistoryList.innerHTML = '';
        let totalTime = 0;
        let totalAltitudeDifference = 0;
        let takeoffLocations = new Set();
        let landingLocations = new Set();
        const totalFlights = flights.length;
        const reversedFlights = flights.slice().reverse();

        if (reversedFlights && reversedFlights.length > 0) {
            reversedFlights.forEach((flight, index) => {
                const [email, date, takeoff, landing, time, altitudeDifference, comments] = flight;
                const flightNumber = totalFlights - index;
                let formattedDate = date;
                if (date) {
                    try {
                        const dateObj = new Date(date);
                        if (!isNaN(dateObj.getTime())) {
                            const day = String(dateObj.getDate()).padStart(2, '0');
                            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                            const year = dateObj.getFullYear();
                            formattedDate = `${day}.${month}.${year}`;
                        } else {
                            const parts = date.split('-');
                            if (parts.length === 3) {
                                formattedDate = `${parts[2]}.${parts[1]}.${parts[0]}`;
                            } else {
                                const userFormatMatch = date.match(/(\d{2})T.*\.(\d{2})\.(\d{4})/);
                                if (userFormatMatch) {
                                    formattedDate = `${userFormatMatch[1]}.${userFormatMatch[2]}.${userFormatMatch[3]}`;
                                }
                            }
                        }
                    } catch (e) {
                        console.error("Date parsing error:", e);
                    }
                }
                const flightTime = parseInt(time) || 0;
                totalTime += flightTime;
                const altitudeDiffValue = parseInt(altitudeDifference.replace('m', '')) || 0;
                totalAltitudeDifference += altitudeDiffValue;
                takeoffLocations.add(takeoff);
                landingLocations.add(landing);
                const listItem = document.createElement('li');
                listItem.className = 'w3-padding-small w3-border-bottom flight-entry';
                listItem.innerHTML = `
                    <p class="flight-route">${flightNumber}. ${takeoff} &rarr; ${landing}</p>
                    <p class="flight-details"><strong>Date:</strong> ${formattedDate} | <strong>Time:</strong> ${time} minutes | <strong>Altitude:</strong> ${altitudeDifference}</p>
                    <p class="flight-details"><strong>Comments:</strong> ${comments}</p>
                `;
                flightHistoryList.appendChild(listItem);
            });
        }
        totalAirTimeSummary.textContent = formatMinutesToHoursAndMinutes(totalTime);
        document.getElementById("altitude-cumulative-dashboard").textContent = `${totalAltitudeDifference}m`;
        const totalFlightsCount = flights.length;
        const totalFlightsCountDisplay = document.getElementById("total-flights-count-display");
        document.getElementById("total-flights-count-display").textContent = totalFlightsCount;
        if (totalFlightsCount >= 50) {
            totalFlightsCountDisplay.classList.add("w3-text-green");
            totalFlightsCountDisplay.classList.remove("w3-text-red");
        } else {
            totalFlightsCountDisplay.classList.add("w3-text-red");
            totalFlightsCountDisplay.classList.remove("w3-text-green");
        }
        const takeoffsCount = takeoffLocations.size;
        const totalTakeoffsCountDisplay = document.getElementById("takeoffs-count-display");
        document.getElementById("takeoffs-count-display").textContent = takeoffsCount;
        if (takeoffsCount >= 5) {
            totalTakeoffsCountDisplay.classList.add("w3-text-green");
            totalTakeoffsCountDisplay.classList.remove("w3-text-red");
        } else {
            totalTakeoffsCountDisplay.classList.add("w3-text-red");
            totalTakeoffsCountDisplay.classList.remove("w3-text-green");
        }
        const landingsCount = landingLocations.size;
        const totalLandingsCountDisplay = document.getElementById("landings-count-display");
        document.getElementById("landings-count-display").textContent = landingsCount;
        if (landingsCount >= 5) {
            totalLandingsCountDisplay.classList.add("w3-text-green");
            totalLandingsCountDisplay.classList.remove("w3-text-red");
        } else {
            totalLandingsCountDisplay.classList.add("w3-text-red");
            totalLandingsCountDisplay.classList.remove("w3-text-green");
        }
    }

    loadButton.addEventListener("click", async () => {
        const userEmail = emailInput.value.trim();
        if (!userEmail) {
            alert("Please enter a valid email address.");
            return;
        }
        modalOverlay.style.display = "none";
        loadingOverlay.style.display = "flex";
        loginTabButton.style.display = 'none';
        dashboardTabButton.style.display = 'none';
        flightDataTabButton.style.display = 'none';
        addflightTabButton.style.display = 'none';
        checklistTabButton.style.display = 'none';
        try {
            const checklistResponse = await fetch(`${scriptURL}?email=${encodeURIComponent(userEmail)}&sheet=Sheet1`);
            const checklistData = await checklistResponse.json();
            const flightResponse = await fetch(`${scriptURL}?email=${encodeURIComponent(userEmail)}&sheet=Sheet2`);
            const flightData = await flightResponse.json();
            if (checklistData && checklistData.status === "success" && flightData && flightData.status === "success") {
                setChecklistValues(checklistData.progress, checklistData.clientName);
                if (flightData.flights) {
                    updateFlightSummary(flightData.flights);
                } else {
                    updateFlightSummary([]);
                }
                dashboardTabButton.style.display = 'block';
                flightDataTabButton.style.display = 'block';
                checklistTabButton.style.display = 'block';
                addflightTabButton.style.display = 'block';
				theoryTabButton.style.display = 'block';
                showTab('dashboard-section');
			    fetchGaugeData(userEmail); 
            } else {
                throw new Error("Data loading failed. Please check your email address and sheets.");
            }
        } catch (error) {
            console.error("Error loading data:", error);
            alert("Error loading data. Please try again.");
            modalOverlay.style.display = "flex";
        } finally {
            loadingOverlay.style.display = "none";
        }
    });

		addflightForm.addEventListener("submit", async function (e) {
			e.preventDefault();
			addflightSaveButton.disabled = true;
			saveFlightLoadingOverlay.style.display = "flex";
			const formData = new FormData(this);
			const flightDate = formData.get("flight-date");
			const utcDate = flightDate ? flightDate + 'T12:00:00.000Z' : '';
			const flightDataObj = {
				email: emailInput.value.trim(),
				flightDate: utcDate,
				takeoffLocation: formData.get("takeoff-location"),
				landingLocation: formData.get("landing-location"),
				flightTime: formData.get("flight-time"),
				comments: formData.get("comments"),
				altitudeDifference: addflightAltitudeDifferenceSpan.textContent
			};
			try {
				const response = await fetch(`${scriptURL}?sheet=Sheet2`, {
					redirect: "follow",
					method: "POST",
					body: JSON.stringify(flightDataObj),
					headers: {
						"Content-Type": "text/plain;charset=utf-8",
					},
				});
				const data = await response.json();
				if (data.status === "success") {
					const flightResponse = await fetch(`${scriptURL}?email=${encodeURIComponent(emailInput.value.trim())}&sheet=Sheet2`);
					const flightData = await flightResponse.json();
					if (flightData && flightData.status === "success" && flightData.flights) {
						updateFlightSummary(flightData.flights);
					}
					// Változás 4: Ha a mentés sikeres, a flag-et false-ra állítjuk
					isDirty = false;
					// Ezzel a sorral frissítjük a mérőórát a mentés után
					fetchGaugeData(emailInput.value.trim()); 
					addflightForm.reset();
					calculateAltitudeDifference(addflightTakeoffSelect, addflightLandingSelect, addflightAltitudeDifferenceSpan);
				} else {
					throw new Error(data.message || "Flight saving failed");
				
				}
			} catch (error) {
				console.error("Error:", error);
				alert("Error: " + error.message);
			} finally {
				addflightSaveButton.disabled = false;
				saveFlightLoadingOverlay.style.display = "none";
			}
		});

    form.addEventListener("submit", async function (e) {
        e.preventDefault();
        submitButton.disabled = true;
        saveChecklistLoadingOverlay.style.display = "flex";
        const userEmail = emailInput.value.trim();
        if (!userEmail) {
            alert("Please enter your email to save.");
            submitButton.disabled = false;
            return;
        }
        const progress = {};
        const checkboxes = document.querySelectorAll('#checklist-container input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            progress[checkbox.name] = checkbox.checked ? "TRUE" : "FALSE";
        });
        const currentTitle = mainTitle.textContent;
        const clientNameMatch = currentTitle.match(/Pilot Checklist - (.+)/);
        const clientName = clientNameMatch ? clientName[1] : '';
        const data = {
            email: userEmail,
            clientName: clientName,
            progress: progress
        };
        try {
            const response = await fetch(`${scriptURL}?sheet=Sheet1`, {
                redirect: "follow",
                method: "POST",
                body: JSON.stringify(data),
                headers: {
                    "Content-Type": "text/plain;charset=utf-8",
                },
            });
            const result = await response.json();
            if (result.status === "success") {
                updateAllCompletions();
                // Változás 5: Ha a mentés sikeres, a flag-et false-ra állítjuk
                isDirty = false;
            } else {
                throw new Error(result.message || "Progress saving failed.");
            }
			 fetchGaugeData(userEmail); 
		} catch (error) {
            console.error("Error saving:", error);
            alert("Error saving: " + error.message);
        } finally {
            submitButton.disabled = false;
            saveChecklistLoadingOverlay.style.display = "none";
        }
    });

    addflightTakeoffSelect.addEventListener('change', () => calculateAltitudeDifference(addflightTakeoffSelect, addflightLandingSelect, addflightAltitudeDifferenceSpan));
    addflightLandingSelect.addEventListener('change', () => calculateAltitudeDifference(addflightTakeoffSelect, addflightLandingSelect, addflightAltitudeDifferenceSpan));
    
    document.addEventListener('DOMContentLoaded', () => {
        modalOverlay.style.display = 'flex';
        loginTabButton.addEventListener('click', () => showTab('login-section'));
        dashboardTabButton.addEventListener('click', () => showTab('dashboard-section'));
        flightDataTabButton.addEventListener('click', () => showTab('flight-data-section'));
        addflightTabButton.addEventListener('click', () => {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${yyyy}-${mm}-${dd}`;
            addflightDateInput.value = formattedDate;
            showTab('addflight-section');
        });
        checklistTabButton.addEventListener('click', () => showTab('checklist-container'));
		theoryTabButton.addEventListener('click', () => showTab('theory-section'));
		
		
        updateAllCompletions();
        document.querySelectorAll('.check-item').forEach(item => {
            item.addEventListener("click", function (event) {
                if (event.target.tagName.toLowerCase() !== 'input' && event.target.className.toLowerCase() !== 'slider') {
                    const checkbox = this.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event("change"));
                    }
                }
            });
        });
        
        // Változás 6: Az állapotváltó beállítása a meglévő eseménykezelőben
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener("change", function () {
                isDirty = true; // EZ AZ ÚJ SOR
                const parentDiv = this.closest('.check-item');
                if (parentDiv) {
                    parentDiv.classList.toggle("completed", this.checked);
                    const card = parentDiv.closest('.w3-card');
                    if (card) {
                        updateCompletion(card);
                    }
                }
            });
        });

        // Változás 7: Az állapotváltó beállítása az "Add Flight" űrlapon
        addflightForm.addEventListener('input', function() {
            isDirty = true;
        });

        calculateAltitudeDifference(addflightTakeoffSelect, addflightLandingSelect, addflightAltitudeDifferenceSpan);
    });
</script>
</body>
</html>